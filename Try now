import pandas as pd
import os
from datetime import datetime
from openpyxl import load_workbook
from openpyxl.styles import PatternFill, Font

# Input Excel file का नाम
input_file = "input.xlsx"

# Output folder
output_folder = "output_groups"
os.makedirs(output_folder, exist_ok=True)

# Excel file की दोनों sheets पढ़ो
data_df = pd.read_excel(input_file, sheet_name="Sheet1")
mapping_df = pd.read_excel(input_file, sheet_name="Sheet2")

# चेक करो कि जरूरी columns मौजूद हैं
if "Assignment Group" not in data_df.columns:
    raise ValueError("Sheet1 में 'Assignment Group' कॉलम missing है!")
if not {"Assignment Group", "Tower"}.issubset(mapping_df.columns):
    raise ValueError("Sheet2 में 'Assignment Group' और 'Tower' दोनों कॉलम होने चाहिए!")

# सिर्फ date निकाल लो Created और Closed से (अगर exist करते हैं)
for col in ["Created", "Closed"]:
    if col in data_df.columns:
        data_df[col] = pd.to_datetime(data_df[col], errors="coerce").dt.strftime("%m-%d-%Y")

# Priority column को साफ करो → सिर्फ dash से पहले वाला हिस्सा रखो
if "Priority" in data_df.columns:
    data_df["Priority"] = data_df["Priority"].astype(str).str.split("-").str[0].str.strip()

# Month का नाम निकालो
current_month = datetime.now().strftime("%B%Y")  # e.g., September2025

# Mapping dictionary बनाओ
mapping_dict = dict(zip(mapping_df["Assignment Group"], mapping_df["Tower"]))

# हर Assignment Group के लिए अलग फाइल बनाओ
for group_name, group_data in data_df.groupby("Assignment Group"):
    # Tower निकालो (अगर missing है तो "UnknownTower")
    tower_name = mapping_dict.get(group_name, "UnknownTower")
    
    # Assignment Group नाम adjust करो → "group" छोटा g
    safe_group = str(group_name).replace("Group", "group")
    
    # Safe नाम बना दो
    safe_tower = str(tower_name).replace("/", "_").replace("\\", "_").replace(" ", "_")
    safe_group = safe_group.replace("/", "_").replace("\\", "_").replace(" ", "_")
    
    # File name बनाओ
    file_name = f"{safe_tower}_{safe_group}_{current_month}.xlsx"
    output_file = os.path.join(output_folder, file_name)
    
    # Data save करो (temporary sheetname)
    group_data.to_excel(output_file, sheet_name="FMAData", index=False)

    # अब formatting apply करो
    wb = load_workbook(output_file)
    ws = wb["FMAData"]

    # Colors
    yellow_fill = PatternFill(start_color="FFFF00", end_color="FFFF00", fill_type="solid")
    red_font = Font(color="FF0000", bold=True)
    blue_fill = PatternFill(start_color="0000FF", end_color="0000FF", fill_type="solid")
    white_font = Font(color="FFFFFF", bold=True)

    # Header row styling
    headers = [cell.value for cell in ws[1]]
    for col_idx, col_name in enumerate(headers, start=1):
        cell = ws.cell(row=1, column=col_idx)
        if col_name in ["Call Reference", "Open-date", "Problem Summary", "Potential Cause", "Category", "Application Name", "Call Type"]:
            cell.fill = yellow_fill
            cell.font = red_font
        elif col_name in ["Title", "Priority", "Closed At", "Closed by (Person)", "Fixed By (Person)",
                          "Failure Point", "Process", "Module", "Region", "Solution Text"]:
            cell.fill = blue_fill
            cell.font = white_font

    wb.save(output_file)
    print(f"Saved: {output_file}")

print("✅ सब reports बन गईं with formatting (simple code + header colors).")
